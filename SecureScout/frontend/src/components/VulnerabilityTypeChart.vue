<template>
  <div class="w-full h-full">
    <Pie
      v-if="loaded && !isEmpty"
      :data="chartData"
      :options="chartOptions"
    />
    <div v-else-if="isEmpty" class="flex items-center justify-center h-full">
      <p class="text-gray-500">No vulnerability data yet</p>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { Pie } from 'vue-chartjs'
import { Chart as ChartJS, ArcElement, Tooltip, Legend, Title } from 'chart.js'

// Register ChartJS components
ChartJS.register(ArcElement, Tooltip, Legend, Title)

const props = defineProps({
  vulnerabilityData: {
    type: Object,
    required: true,
    default: () => ({})
  }
})

const loaded = ref(false)
const isEmpty = computed(() => {
  const counts = Object.values(props.vulnerabilityData)
  return counts.length === 0 || counts.every(count => count === 0)
})

// Vulnerability type English name mapping
const vulnerabilityTypeNames = {
  'sql_injection': 'SQL Injection',
  'xss': 'Cross-site Scripting (XSS)',
  'csrf': 'Cross-site Request Forgery (CSRF)',
  'file_upload': 'File Upload Vulnerability',
  'error': 'Error',
  'other': 'Other'
}

// Vulnerability type colors
const vulnerabilityColors = {
  'sql_injection': '#ff4d4f',
  'xss': '#faad14',
  'csrf': '#1890ff',
  'file_upload': '#722ed1',
  'error': '#bfbfbf',
  'other': '#52c41a'
}

// Chart data
const chartData = computed(() => {
  if (isEmpty.value) return { labels: [], datasets: [{ data: [] }] }
  
  const labels = []
  const data = []
  const backgroundColor = []
  
  Object.entries(props.vulnerabilityData).forEach(([type, count]) => {
    // Get display name, use original if not mapped
    const displayName = vulnerabilityTypeNames[type] || (type.charAt(0).toUpperCase() + type.slice(1)).replace(/_/g, ' ')
    labels.push(displayName)
    data.push(count)
    
    // Get color, use default if not mapped
    const color = vulnerabilityColors[type] || '#1890ff'
    backgroundColor.push(color)
  })
  
  return {
    labels,
    datasets: [
      {
        data,
        backgroundColor,
        borderWidth: 1,
        borderColor: '#ffffff'
      }
    ]
  }
})

// Chart options
const chartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: {
      position: 'right',
      labels: {
        boxWidth: 15,
        font: {
          size: 12
        }
      }
    },
    title: {
      display: false
    },
    tooltip: {
      callbacks: {
        label: function(context) {
          const label = context.label || ''
          const value = context.parsed || 0
          const total = context.dataset.data.reduce((a, b) => a + b, 0)
          const percentage = Math.round((value / total) * 100)
          return `${label}: ${value} (${percentage}%)`
        }
      }
    }
  }
}

// Set loaded state after component is mounted
onMounted(() => {
  loaded.value = true
})

// Update chart when vulnerability data changes
watch(() => props.vulnerabilityData, () => {
  loaded.value = true
}, { deep: true })
</script>