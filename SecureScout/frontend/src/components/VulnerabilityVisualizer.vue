<template>
  <div class="vulnerability-visualizer">
    <!-- Vulnerability Overview Card -->
    <div class="overview-card bg-white rounded-lg shadow-md p-6 mb-6">
      <h3 class="text-lg font-semibold mb-4">{{ title }}</h3>
      
      <div v-if="!vulnerabilities || vulnerabilities.length === 0" class="text-center py-4">
        <el-empty description="No vulnerabilities found" />
      </div>
      
      <div v-else>
        <!-- Vulnerability Count Indicators -->
        <div class="flex items-center justify-between mb-4">
          <div class="text-xl font-bold">
            Found <span class="text-danger">{{ vulnerabilities.length }}</span> vulnerabilities
          </div>
          
          <div class="flex gap-2">
            <el-tag v-if="getSeverityCount('High') > 0" type="danger">
              High: {{ getSeverityCount('High') }}
            </el-tag>
            <el-tag v-if="getSeverityCount('Medium') > 0" type="warning">
              Medium: {{ getSeverityCount('Medium') }}
            </el-tag>
            <el-tag v-if="getSeverityCount('Low') > 0" type="info">
              Low: {{ getSeverityCount('Low') }}
            </el-tag>
          </div>
        </div>
        
        <!-- Vulnerability Distribution Chart -->
        <div ref="chartRef" class="h-60 mb-4"></div>
        
        <!-- Security Score -->
        <div class="flex items-center justify-between">
          <div class="flex flex-col items-center">
            <div class="mb-1">Security Score</div>
            <div class="relative">
              <el-progress 
                type="dashboard" 
                :percentage="securityScore" 
                :color="getScoreColor(securityScore)"
                :stroke-width="8"
              />
              <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-2xl font-bold">{{ securityScore }}</span>
              </div>
            </div>
          </div>
          
          <div class="recommendation p-4 bg-gray-50 rounded-lg max-w-md">
            <div class="font-medium mb-2">Security Recommendation</div>
            <div class="text-sm text-gray-700">
              {{ securityRecommendation }}
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Vulnerability Details List -->
    <div v-if="vulnerabilities && vulnerabilities.length > 0" class="bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Vulnerability Details</h3>
        <el-radio-group v-model="filter" size="small">
          <el-radio-button label="all">All</el-radio-button>
          <el-radio-button label="sql_injection" v-if="hasVulnType('sql_injection')">SQL Injection</el-radio-button>
          <el-radio-button label="xss" v-if="hasVulnType('xss')">XSS</el-radio-button>
          <el-radio-button label="csrf" v-if="hasVulnType('csrf')">CSRF</el-radio-button>
          <el-radio-button label="file_upload" v-if="hasVulnType('file_upload')">File Upload</el-radio-button>
          <el-radio-button label="other" v-if="hasOtherVulnTypes">Other</el-radio-button>
        </el-radio-group>
      </div>
      
      <!-- Vulnerability List -->
      <el-table :data="filteredVulnerabilities" style="width: 100%">
        <el-table-column label="Vulnerability Type" min-width="120">
          <template #default="{ row }">
            <div class="flex items-center">
              <el-tag :type="getTypeColor(row.type)" class="mr-2">
                {{ getVulnTypeName(row.type) }}
              </el-tag>
            </div>
          </template>
        </el-table-column>
        
        <el-table-column label="Risk Level" width="100">
          <template #default="{ row }">
            <el-tag 
              :type="getSeverityType(row.severity)" 
              effect="dark"
              size="small"
            >
              {{ row.severity }}
            </el-tag>
          </template>
        </el-table-column>
        
        <el-table-column label="Location" min-width="200">
          <template #default="{ row }">
            <el-tooltip
              :content="row.url || row.test_url || 'No location information'"
              placement="top"
              :show-after="500"
            >
              <span class="truncate block">{{ row.url || row.test_url || 'No location information' }}</span>
            </el-tooltip>
          </template>
        </el-table-column>
        
        <el-table-column label="Description" min-width="250">
          <template #default="{ row }">
            <div>{{ row.description }}</div>
          </template>
        </el-table-column>
        
        <el-table-column label="Operation" width="100" fixed="right">
          <template #default="{ row }">
            <el-button
              text
              type="primary"
              @click="showVulnDetails(row)"
            >
              Details
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </div>
    
    <!-- Vulnerability Details Dialog -->
    <el-dialog
      v-model="dialogVisible"
      title="Vulnerability Details"
      width="60%"
      destroy-on-close
    >
      <template v-if="selectedVuln">
        <div class="vuln-detail">
          <div class="bg-gray-50 p-4 rounded-lg mb-4">
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-lg font-medium">{{ getVulnTypeName(selectedVuln.type) }}</h3>
              <el-tag 
                :type="getSeverityType(selectedVuln.severity)" 
                effect="dark"
              >
                {{ selectedVuln.severity }}
              </el-tag>
            </div>
            <p>{{ selectedVuln.description }}</p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div v-if="selectedVuln.url">
              <div class="text-sm text-gray-500 mb-1">URL:</div>
              <div class="break-all">{{ selectedVuln.url }}</div>
            </div>
            
            <div v-if="selectedVuln.test_url">
              <div class="text-sm text-gray-500 mb-1">Test URL:</div>
              <div class="break-all">{{ selectedVuln.test_url }}</div>
            </div>
          </div>
          
          <div v-if="selectedVuln.details" class="mb-4">
            <div class="text-sm text-gray-500 mb-1">Details:</div>
            <div class="bg-gray-50 p-3 rounded font-mono text-sm overflow-auto max-h-40">
              {{ selectedVuln.details }}
            </div>
          </div>
          
          <div v-if="selectedVuln.evidence" class="mb-4">
            <div class="text-sm text-gray-500 mb-1">Evidence:</div>
            <div class="bg-gray-50 p-3 rounded font-mono text-sm overflow-auto max-h-40">
              {{ selectedVuln.evidence }}
            </div>
          </div>
          
          <el-divider>Remediation Advice</el-divider>
          
          <div v-if="selectedVuln.type === 'sql_injection'">
            <SQLInjectionGuidance />
          </div>
          <div v-else-if="selectedVuln.type === 'xss'">
            <XSSGuidance />
          </div>
          <div v-else>
            <div class="text-sm">
              {{ getRemediationAdvice(selectedVuln.type) }}
            </div>
          </div>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { ElMessage } from 'element-plus'
import * as echarts from 'echarts/core'
import { PieChart } from 'echarts/charts'
import { TooltipComponent, LegendComponent, TitleComponent } from 'echarts/components'
import { CanvasRenderer } from 'echarts/renderers'
import SQLInjectionGuidance from './guidance/SQLInjectionGuidance.vue'
import XSSGuidance from './guidance/XSSGuidance.vue'

// Register required ECharts components
echarts.use([PieChart, TooltipComponent, LegendComponent, TitleComponent, CanvasRenderer])

const props = defineProps({
  title: {
    type: String,
    default: 'Vulnerability Analysis'
  },
  vulnerabilities: {
    type: Array,
    default: () => []
  }
})

const chartRef = ref(null)
const chart = ref(null)
const filter = ref('all')
const dialogVisible = ref(false)
const selectedVuln = ref(null)

// Vulnerability type name mapping
const vulnTypeNames = {
  'sql_injection': 'SQL Injection',
  'xss': 'Cross-site Scripting (XSS)',
  'csrf': 'Cross-site Request Forgery (CSRF)',
  'file_upload': 'File Upload Vulnerability',
  'error': 'Error'
}

// Vulnerability remediation advice
const remediationAdvice = {
  'sql_injection': '1. Use parameterized queries or prepared statements\n2. Strictly validate all user input\n3. Use ORM frameworks\n4. Limit database account permissions\n5. Implement input/output filtering at the application layer',
  'xss': '1. HTML-encode all user input\n2. Implement Content Security Policy (CSP)\n3. Use secure bindings of modern frameworks\n4. Set appropriate X-XSS-Protection headers\n5. Avoid inserting user input directly into JavaScript',
  'csrf': '1. Use CSRF tokens in all forms\n2. Validate the Referer header in requests\n3. Use captchas for sensitive operations\n4. Use the SameSite cookie attribute\n5. Implement double submit cookie pattern',
  'file_upload': '1. Validate file type, size, and content\n2. Use secure file names and storage paths\n3. Never execute uploaded files\n4. Store files outside the web root\n5. Use a CDN or dedicated server to handle files',
  'error': 'Check system logs for more information'
}

// Computed properties
const securityScore = computed(() => {
  if (!props.vulnerabilities || props.vulnerabilities.length === 0) return 100
  
  // Assign different weights by severity
  const weights = {
    'High': 25,
    'Medium': 15,
    'Low': 5
  }
  
  let weightedSum = 0
  props.vulnerabilities.forEach(vuln => {
    weightedSum += weights[vuln.severity] || weights['Medium']
  })
  
  // Calculate score and ensure it is between 0-100
  const score = Math.max(0, 100 - weightedSum)
  return Math.round(score)
})

const securityRecommendation = computed(() => {
  const score = securityScore.value
  
  if (score >= 90) {
    return 'The website is in good security condition. It is recommended to perform regular security scans to maintain a good security posture.'
  } else if (score >= 70) {
    return 'There are some potential security risks on the website. It is recommended to fix the discovered vulnerabilities and strengthen security measures in a timely manner.'
  } else if (score >= 40) {
    return 'There are many security risks on the website. It is recommended to immediately fix high-risk vulnerabilities and conduct a comprehensive security assessment and reinforcement.'
  } else {
    return 'There are serious security risks on the website. It is recommended to take the site offline immediately and perform a comprehensive security overhaul.'
  }
})

const filteredVulnerabilities = computed(() => {
  if (filter.value === 'all') {
    return props.vulnerabilities
  } else if (filter.value === 'other') {
    // Filter for vulnerabilities not in main categories
    const mainTypes = ['sql_injection', 'xss', 'csrf', 'file_upload']
    return props.vulnerabilities.filter(vuln => !mainTypes.includes(vuln.type))
  } else {
    // Filter by type
    return props.vulnerabilities.filter(vuln => vuln.type === filter.value)
  }
})

const hasOtherVulnTypes = computed(() => {
  const mainTypes = ['sql_injection', 'xss', 'csrf', 'file_upload']
  return props.vulnerabilities.some(vuln => !mainTypes.includes(vuln.type))
})

// Methods
function hasVulnType(type) {
  return props.vulnerabilities.some(vuln => vuln.type === type)
}

function getVulnTypeName(type) {
  return vulnTypeNames[type] || type
}

function getRemediationAdvice(type) {
  return remediationAdvice[type] || 'Please refer to relevant security guidelines for remediation.'
}

function getSeverityCount(severity) {
  return props.vulnerabilities.filter(vuln => vuln.severity === severity).length
}

function getSeverityType(severity) {
  switch (severity) {
    case 'High': return 'danger'
    case 'Medium': return 'warning'
    case 'Low': return 'info'
    default: return 'warning'
  }
}

function getTypeColor(type) {
  switch (type) {
    case 'sql_injection': return 'danger'
    case 'xss': return 'warning'
    case 'csrf': return 'info'
    case 'file_upload': return 'warning'
    default: return 'info'
  }
}

function getScoreColor(score) {
  if (score >= 90) return '#67C23A'
  if (score >= 70) return '#E6A23C'
  if (score >= 40) return '#F56C6C'
  return '#F56C6C'
}

function showVulnDetails(vuln) {
  selectedVuln.value = vuln
  dialogVisible.value = true
}

function initChart() {
  if (!chartRef.value) return
  
  // Dispose old chart
  if (chart.value) {
    chart.value.dispose()
  }
  
  // Do not initialize chart if there are no vulnerabilities
  if (!props.vulnerabilities || props.vulnerabilities.length === 0) return
  
  // Count vulnerabilities by type
  const vulnTypeCount = {}
  props.vulnerabilities.forEach(vuln => {
    const type = getVulnTypeName(vuln.type)
    vulnTypeCount[type] = (vulnTypeCount[type] || 0) + 1
  })
  
  // Prepare data
  const data = Object.entries(vulnTypeCount).map(([name, value]) => ({ name, value }))
  
  // Initialize chart
  chart.value = echarts.init(chartRef.value)
  
  // Chart options
  const option = {
    tooltip: {
      trigger: 'item',
      formatter: '{a} <br/>{b}: {c} ({d}%)'
    },
    legend: {
      top: '5%',
      left: 'center',
      data: data.map(item => item.name)
    },
    series: [
      {
        name: 'Vulnerability Type',
        type: 'pie',
        radius: ['40%', '70%'],
        avoidLabelOverlap: false,
        itemStyle: {
          borderRadius: 10,
          borderColor: '#fff',
          borderWidth: 2
        },
        label: {
          show: false,
          position: 'center'
        },
        emphasis: {
          label: {
            show: true,
            fontSize: '18',
            fontWeight: 'bold'
          }
        },
        labelLine: {
          show: false
        },
        data: data
      }
    ]
  }
  
  // Render chart
  chart.value.setOption(option)
}

// Watch for vulnerability data changes and re-initialize chart
watch(() => props.vulnerabilities, () => {
  initChart()
}, { deep: true })

// Initialize chart after component is mounted
onMounted(() => {
  initChart()
  
  // Responsive to window resize
  window.addEventListener('resize', () => {
    if (chart.value) {
      chart.value.resize()
    }
  })
})
</script>

<style scoped>
.vulnerability-visualizer {
  width: 100%;
}
</style>